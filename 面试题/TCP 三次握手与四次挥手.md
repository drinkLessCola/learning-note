## 1.TCP 三次握手

1. 第一次握手：
   - 建立连接时，客户端发送 syn 包 （syn=j) 到服务器
     - SYN:同步序列编号（Synchronize Sequence Numbers）
   - 客户端进入 `SYN_SENT` 状态，等待服务器确认
2. 第二次握手：
   - 服务器收到 syn 包并确认客户端的 SYN（ack=syn+1)
   - 同时发送自己的 SYN 包（syn=k)
   - 即发送 SYN+ACK 包
   - 服务器进入 `SYN_RECV` 状态
3. 第三次握手：
   - 客户端收到服务器的 SYN+ACK 包，向服务器发送确认包 ACK (ack=k+1)
   - 包发送完毕后，客户端和服务端进入 ESTABLISHED 状态，TCP 连接成功，完成三次握手。

握手过程中传送的包里不包含数据，三次握手完毕后，客户端与服务器才正式开始传送数据。

## 2. TCP 四次挥手

1. 客户端发出连接释放报文，并停止发送数据。
   - 释放数据报文首部，FIN = 1，其序列号 seq=u（前面已经传送过来的数据的最后一个字节的序号加1）
     - TCP规定，FIN 报文段即使不携带数据，也要消耗一个序号。
   - 客户端进入 FIN-WAIT-1 状态。
2. 服务器收到连接释放报文，发出确认报文。
   - ACK=1，ack=u+1，并且带上自己的序列号 seq=v
   - 服务端进入 CLOSE-WAIT （关闭等待）状态。
   - TCP服务器通知高层的应用进程，进入半关闭状态，客户端向服务端的方向释放，但是在 CLOSE-WAIT 整个状态中，如果服务器发送数据，客户端依然要接受。
3. 客户端收到服务器的确认响应后
   - 此时，客户端进入 FIN-WAIT-2 状态
   - 等待服务器发送连接释放报文
4. 服务器将最后的数据发送完毕，向客户端发送连接释放报文。
   - FIN=1 ack=u+1
   - 半关闭状态，服务器可能又发送了一些数据，假定此时的序列号为seq=w
   - 服务器进入了 LAST-ACK 状态（最后确认）
   - 等待客户端确认
5. 客户端收到服务器的连接释放报文后，必须发出确认
   - ACK=1 ack=w+1 自己的序列号为seq=u+1
   - 客户端进入 TIME-WAIT 状态（时间等待）
   - 此时 TCP 连接还没有释放，必须经过 2^MSL （最长报文段寿命）的时间
     - 一般 MSL = 2min
     - 确保第四次挥手时，发送方发送的 ACK 可以到达接收方，如果2MSL 没收到，接收方会重发。
     - 确保整个连接的所有报文都已过期
   - 客户端撤销相应的 TCB 后，才进入 CLOSED 状态。
     - TCB 传输控制块 确保数据正确分发，将数据封装起来的数据结构
     - 包含数据发送双方对应的 socket 信息（IP地址 + 端口号）和拥有装载数据的缓冲区
6. 服务器收到客户端发出的确认
   - 立即进入 CLOSED 状态。
   - 撤销 TCB 后就结束了这次的 TCP 连接。
   - 服务器结束 TCP 连接的时间比客户端早。



