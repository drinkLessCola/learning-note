## 2.5 P2P 文件分发

单一服务器向大量主机（称为对等方）分发一个大文件。

- 在客户-服务器文件分发中，该服务器必须向每个对等方发送该文件的一个副本，即服务器承受了极大的负担，并且消耗了大量的服务器带宽。
- 在 P2P 文件分发中，每个对等方 能够向 任何其他对等方 重新分发它已经收到的该文件的**任何部分**，从而在分发过程中协助该服务器。

**最为流行的 P2P 文件分发协议是 BitTorrent。**



#### 1.P2P体系结构的扩展性

将一个文件分发给一个固定对等方集合。服务器和对等方使用接入链路与因特网相连。

- u~s~ 服务器接入链路的上载速率。
- u~i~ 第 i 对等方接入链路的上载速率。
- d~i~ 第 i 对等方接入链路的下载速率。
- F 被分发的文件长度
- N 要获得该文件副本的对等方的数量。

**分发时间**：所有 N 个对等方得到该文件的副本所需要的时间。

做出假设：

- 因特网核心具有足够的带宽，这意味着所有瓶颈都在网络接入链路。
- 它们的所有上传和下载访问带宽能被全部用于分发该文件。

**客户-服务器体系结构的分发时间 D~cs~ :**

- 服务器上传最短时间：NF/u~s~
- 最小下载速率对等方的最短下载时间：F/d~min~(d~min~ = min {d~1~,d~2~,…,d~N~})

<img src="C:\Users\Zirina\AppData\Roaming\Typora\typora-user-images\image-20220720132749537.png" alt="image-20220720132749537" style="zoom:80%;" />

对足够大的 N，客户-服务器分发时间由 NF / u~s~ 确定。

**P2P 体系结构的分发时间 D~P2P~**

- 在分发的开始，只有服务器具有文件，必须经其接入链路至少发送该文件的每个比特一次。至少为 F/u~s~ 。
- 具有最低下载速率的对等方的最短下载时间：F/d~min~
- 系统整体的总上载能力 = 服务器的上载速率 + 每个单独的对等方的上载速率
  - u~total~ = u~s~ + u~1~ + … + u~N~
  - 系统必须向这 N 个对等方的每个交付 F 比特，总共上载 NF 比特。
  - 最小分发时间至少为 NF / u~total~

<img src="C:\Users\Zirina\AppData\Roaming\Typora\typora-user-images\image-20220720134148131.png" alt="image-20220720134148131" style="zoom:80%;" />

如果每个对等方接收到一个比特就能够重分发一个比特的话，则存在一个重新分发方案能实际取得这种下界。**实际上，被分发的是文件块而不是一个个比特。**

<img src="C:\Users\Zirina\AppData\Roaming\Typora\typora-user-images\image-20220720134519785.png" alt="image-20220720134519785" style="zoom:80%;" />

对于任意的对等方数量 N，分发时间总是小于一个界限。

**P2P 体系结构的应用程序是能够自扩展的**。

- 对等方除了是比特的消费者外还是它们的重新分发者。

#### 2. BitTorrent

**BitTorrent 是一种用于文件分发的流行 P2P 协议。**

**洪流（torrent）**：参与一个特定文件分发的所有对等方的集合。

在一个洪流中的对等方彼此下载等长度的文件块（chunk），典型的块长度为 256 KB。

- 一个对等方第一次加入一个洪流时，它没有块。
- 当对等方下载块时，也为其他对等方上载了多个块。
- 一旦对等方获得了整个文件，可能：
  - 离开洪流
  - 留在洪流中并继续向其他对等方上载块
- 任何对等方可能在任何时候仅具有块的子集就离开该洪流，并在以后重新加入该洪流中。

**追踪器**：每个洪流具有的一个基础设施节点。

当一个对等方 A 加入洪流时：

- 向追踪器注册自己。
- 并周期性地通知追踪器它仍在洪流中。

追踪器随机地从参与对等方的集合中选择**对等方的一个子集**，将对等方的 **IP 地址**发送给 A。

A 试图与列表上的所有对等方创建**并行的 TCP 连接**。

**邻近对等方**：所有与 A 成功创建 TCP 连接的对等方。

- 一个对等方的邻近对等方将随时间而波动。

在任何给定时间，每个对等方将具有来自该文件的块的子集，并且不同的对等方具有不同的子集。

A **周期性**地（经 TCP 连接）询问<u>每个邻近对等方它们所具有的块列表</u>。并对自己还没有的块发出请求。

**决定请求哪些块：**

==**最稀缺优先**==：针对**没有的块**在邻居中**决定最稀缺的块**（在邻居中副本数量最少的块），并**首先请求那些最稀缺的块**。

- 目标是均衡每个块在洪流中的副本数量。

**响应哪个请求**：

==**对换算法**==：根据当前**能够以最高速率向她提供数据**的邻居，给出其优先权。（一报还一报）

- 对于每个邻居都持续地测量接收到比特的速率。
- 确定以最高速率流入的 4 个邻居。
- 每过 10 秒，重新计算该速率并修改这 4 个对等方的集合。
- 每过 30 秒，A 随机地选择一名新的对换伴侣 B 并与那位伴侣进行对换。如果两名对等方满足对换，它们将对方放入其前 4 位列表中并继续与对方进行对换，直到<u>该对等方之一发现了一个更好的伴侣为止。</u>
  - A 可能成为 B 的前 4 位上载者之一，B 将开始向 A 发送数据。
  - 如果 B 向 A 发送数据速率足够高， B 也将成为 A 的前 4 位上载者。

**疏通（unchoked）**：以最高速率流入的 4 个对等方。

==**对等方能够趋于找到彼此的协调的速率上载**。==

除了这 5 个对等方（前 4 个对等方 和 一个试探的对等方），**所有其他相邻对等方均被“阻塞”。**

 BitTorrent 的其他机制：

- 片（小块）
- 流水线
- 随机优先选择
- 残局模型
- 反怠慢



#### 3. 另一种 P2P 应用 —— 分布式散列表（DHT）

分布式散列表是一种简单的数据库。

其数据库记录分布在**一个 P2P 系统的多个对等方上。**

## 2.6 视频流和内容分发网

视频的一个重要特征是能够被**压缩**，因而可用**比特率**来权衡视频质量。

视频具有 **高比特率** 的特点。

对流式视频的最为重要的性能度量是 **平均端到端吞吐量**。

- 网络必须为流式应用提供平均吞吐量。

### 6.2 HTTP 流和 DASH

在 HTTP 流中，视频只是存储在 HTTP 服务器中作为一个普通的文件，每个文件有一个特定的 URL。

客户与服务器创建一个 TCP 连接并发送对该 URL 的 HTTP GET 请求。服务器在一个 HTTP 响应报文中发送该视频文件。

**流式视频应用程序接收到视频就进行播放，同时缓存该视频后面部分的帧。**

- 在客户一侧，字节被收集在客户应用缓存中。一旦缓存中的字节数量超过预先设定的门限，客户应用程序就开始播放。

- 流式视频应用程序周期性地从客户应用程序缓存中抓取帧并解压缩

**HTTP 流具有严重缺陷，即所有客户接收到相同编码的视频。**

对不同的客户或者对于相同客户的不同时间而言，客户可用的宽带大小有很大不同。



**经 HTTP 的动态适应性流**（DASH）：

- 视频被编码为几个不同版本，每个版本有不同的比特率，对应不同质量水平。
- 客户动态地请求来自不同版本且长度为几秒的视频段数据块。
- 根据可用宽带量选择不同版本的块。
- 用 HTTP GET 请求报文一次选择一个不同的块。

**DASH 允许客户使用==不同的以太网接入速率==流式播放具有不同编码速率的视频**。

DASH 每个视频版本存储在 HTTP 服务器中，每个版本都有一个不同的 URL。

**HTTP 服务器也有一个 ==告示文件==**，为每个版本提供了一个 URL 及其比特率。

客户通过在 HTTP GET 请求报文中对每块指定一个 URL 和一个字节范围来选择一块。

**DASH 允许客户自由地在不同的质量等级之间切换**。

下载块的同时，客户也<u>测量接收带宽</u>，并运行一个 **速率决定算法** 来决定下次请求的块。



### 6.3 内容分发网

提供流式视频服务最直接的方法：

建立单一的大规模数据中心，在数据中心中存储其所有视频，并直接从该数据中心向世界范围的客户传输流式视频。

这种方法存在三个问题：

- 客户远离数据中心，**服务器到客户的分组将跨越许多通信链路并很可能通过许多 ISP**。
  - 如果链路之一提供的吞吐量小于视频消耗速率，**端到端吞吐量也将小于该消耗速率**，给用户带来停滞时延。
- 流行的视频很可能 **经过相同的通信链路** 发送许多次。
  - 浪费了网络带宽
  - 因特网视频公司将为向因特网反复发送相同的字节而向其 ISP 运营商支付费用。
- 单个数据中心代表一个**单点故障**。
  - 如果数据中心或其通向因特网的链路崩溃，它将不能够分发任何视频流。

为了应对向分布于全世界的用户分发巨量视频数据的挑战，几乎所有主要的视频流公司都利用 **内容分发网（Content Distribution Network，CDN）**。

- CDN 管理分布在多个地理位置上的服务器
- 在服务器上存储视频
- 试图将每个用户请求定向到一个将提供最好的用户体验的 CDN 位置。

CDN 的类型：

- 专用 CDN。 由内容提供商自己所有。
- 第三方 CDN。代表多个内容提供商分发内容。

**CDN 通常采用两种不同的服务器安置原则**：

- **深入。** 通过在遍及全球的**接入 ISP 中部署服务器集群**来**深入**到 ISP 的接入网中。
- **邀请做客**。通过在少量**关键位置建造大集群**来邀请到 ISP 做客。
  - 通常将它们的集群放置在**因特网交换点（IXP）**。
  - 邀请做客设计通常产生较低的维护和管理开销
  - 可能以对端用户的较高时延和较低吞吐量为代价。

一旦 CDN 的集群准备就绪，就可以**跨集群复制内容**。

事实上，许多 CDN 并没有将视频推入它们的集群，而是一种简单的**拉策略**：

- 如果客户向一个未存储该视频的集群请求某视频，则该集群检索该视频，向客户流式传输视频同时在本地存储一个副本。
- 当集群存储器变满时，它删除不经常请求的视频。

#### 1.CDN 操作

当用户主机中的一个浏览器指令检索一个特定的视频（由 URL 标识）时，**CDN 必须截获该请求**，以便能够：

1. 确定此时**适合用于该客户的 CDN 服务器集群**。
2. 将客户的**请求重定向**到该集群的某台服务器。

**大多数 CDN 利用 ==DNS 来截获和重定向请求==**。

- 主机发送一个 DNS 请求
- 用户的**本地 DNS 服务器（LDNS）**将该请求中继到一台**权威 DNS 服务器**
- 权威 DNS 服务器并不返回一个 IP 地址，而是向 LDNS 返回一个 **CDN 域的主机名**，将该 DNS 请求移交给 KingCDN。
- DNS 请求进入了 CDN 专用 DNS 基础设施。用户的 LDNS 发送第二个请求，是**对 CDN 的 DNS 请求。**
- **CDN 的 DNS 系统**最终向 LDNS 返回了 **CDN 内容服务器的 IP 地址**。
- 客户收到 IP 后与服务器创建了直接的 TCP 连接。
  - HTTP 流：发出对该视频的 HTTP GET 请求
  - DASH：服务器首先向客户发送具有 URL 列表的 **告示文件**。每个 URL 对应视频的每个版本，<u>并且客户将动态地选择来自不同版本的块</u>。

#### 2. 集群选择策略

任何 CDN 部署，其核心是 **集群选择策略**：<u>即动态地将客户定向到 CDN 中的某个服务器集群或数据中心的机制。</u>

CDN 需要基于客户 LDNS 服务器 的 IP 地址选择一个适当集群。

CDN 一般采用专用的集群选择策略。

- 指派客户到**地理上最为邻近**的集群。
  - 就网络路径的长度和跳数来说，**地理最邻近的集群并不是最近的集群**。
  - （所有基于 DNS 方法都内在具有的问题）某些端用户配置使用**位于远地的 LDNS**。
  - 这种简单的策略忽略了**时延和可用带宽随因特网路径时间而变化**，总是为特定的客户指派相同的集群。
- **基于当前流量条件**决定集群。
  - CDN 能够对其集群和客户之间的**时延和丢包性能**执行周期性的**实时测量**。
  - 如周期性地向位于全世界的所有 **LDNS 发送探测分组**。（如 ping 报文或 DNS 请求），但有许多 LDNS 被配置为不会响应这些探测。





